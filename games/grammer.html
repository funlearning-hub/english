<!DOCTYPE html>
<html>
<head>
  <title>English Grammar Game</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f6f6f6;
    }
    .container {
      max-width: 700px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
      text-align: center;
    }
    .btn {
      padding: 10px 20px;
      margin: 8px;
      border: none;
      border-radius: 6px;
      background: #007bff;
      color: white;
      cursor: pointer;
      font-size: 15px;
    }
    .btn:hover { background: #0056c7; }
    .answer-btn {
      display: block;
      width: 100%;
      margin: 8px 0;
      padding: 12px;
      font-size: 18px;
    }
    #reward { font-size: 18px; color: #ff9800; font-weight: bold; min-height: 24px; }
    #streakBarContainer {
      width: 100%;
      background: #ddd;
      height: 20px;
      border-radius: 12px;
      margin-top: 5px;
      overflow: hidden;
    }
    #streakBar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #ffea00, #ff9800);
      border-radius: 12px;
      transition: width 0.3s ease;
    }
    #powerups { margin-top: 10px; }
    .powerup {
      background: #ff4081;
      color: white;
      padding: 8px 14px;
      margin: 5px;
      border-radius: 8px;
      cursor: pointer;
      display: inline-block;
      font-weight: bold;
      font-size: 14px;
    }
    .powerup.disabled { opacity: 0.5; cursor: default; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
    th { background: #f0f0f0; }
    #historyEmpty { font-size: 14px; color: #777; }
  </style>
</head>
<body>

<!-- START SCREEN -->
<div class="container" id="startScreen">
  <h2>English Grammar Game</h2>
  <p>Enter your name to start. This device keeps a history of all attempts.</p>
  <input type="text" id="playerName" placeholder="Enter your name" style="padding:8px; width:60%; max-width:260px;">
  <br>
  <button class="btn" onclick="startGame()">Start Game</button>
  <h3>Past Attempts (This Device)</h3>
  <div id="historyContainer">
    <p id="historyEmpty">No attempts yet. Play a round to see scores here.</p>
    <table id="historyTable" style="display:none;">
      <thead>
        <tr><th>#</th><th>Name</th><th>Score</th><th>Time</th></tr>
      </thead>
      <tbody id="historyBody"></tbody>
    </table>
  </div>
</div>

<!-- GAME SCREEN -->
<div class="container" id="gameContainer" style="display:none;">
  <h2>English Grammar Game</h2>
  <p>Player: <span id="currentPlayerLabel"></span></p>
  <p>Time Left: <span id="timer">60</span>s</p>
  <p>Score: <span id="score">0</span> | Streak: <span id="streak">0</span></p>
  <div id="streakBarContainer"><div id="streakBar"></div></div>
  <div id="reward"></div>
  <div id="powerups"></div>
  <hr>
  <p>Question:</p>
  <div id="expression" style="font-size: 28px; margin: 20px;"></div>
  <div id="answers"></div>
  <p id="feedback" style="font-size: 18px; font-weight: bold;"></p>
  <button class="btn" onclick="backToStart()">Back to Start</button>
</div>

<!-- END SCREEN -->
<div class="container" id="endScreen" style="display:none;">
  <h2>Round Over</h2>
  <p>Player: <span id="finalPlayer"></span></p>
  <p>Final Score: <span id="finalScore"></span></p>
  <button class="btn" onclick="playAgainSamePlayer()">Play Again</button>
  <button class="btn" onclick="backToStart()">Back to Start</button>
</div>

<script>
let score = 0;
let streak = 0;
let timeLeft = 300;
let timerInterval = null;
let doublePoints = false;
let freezeTime = false;
let currentPlayer = "";
let currentCorrect = "";
let questionsFromSheet = [];
let remainingQuestions = [];
let powerupsShown = false;

const STORAGE_KEY = "english_game_attempts";
const SHEET_URL = "https://script.google.com/macros/s/AKfycbwOI6-NmdeH37pqNpFZm1fnXjBfCVuvp4GHb4bii5MLRj18pzghAvQ1X99OK9VCTWUM/exec"; // Replace with your Apps Script URL

const correctSound = new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg");
const wrongSound = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");
const powerupSound = new Audio("https://actions.google.com/sounds/v1/cartoon/pop.ogg");

function r(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

// ===== LOAD QUESTIONS BEFORE GAME START =====
async function loadQuestions(){
  try{
    const res = await fetch(SHEET_URL);
    questionsFromSheet = await res.json();
    console.log("Questions loaded:", questionsFromSheet.length);
  } catch(err){
    console.error("Error loading questions:", err);
  }
}

// ===== NEW QUESTION =====
function newQuestion(){
  if(!remainingQuestions.length){
    endRound(); // end game if no questions left
    return;
  }

  const index = r(0, remainingQuestions.length-1);
  const q = remainingQuestions.splice(index,1)[0]; // remove from remainingQuestions
  currentCorrect = q.correct;
  document.getElementById("expression").textContent = q.question;

  const div = document.getElementById("answers");
  div.innerHTML = "";
  const options = q.options.sort(()=>Math.random()-0.5);
  options.forEach(opt=>{
    const btn = document.createElement("button");
    btn.className = "btn answer-btn";
    btn.textContent = opt;
    btn.onclick = () => checkAnswer(btn,opt,currentCorrect,q.question);
    div.appendChild(btn);
  });

  document.getElementById("feedback").textContent = "";
  document.getElementById("reward").textContent = "";
}

// ===== CHECK ANSWER =====
function checkAnswer(btn, choice, correct, question){
  if(choice===correct){
    correctSound.play();
    score += doublePoints ? 2 : 1;
    streak++;
    document.getElementById("feedback").textContent = "Correct!";
    handleStreakRewards();
  } else {
    wrongSound.play();
    streak=0;
    document.getElementById("feedback").textContent = "Wrong. Correct: "+correct;
  }
  document.getElementById("score").textContent = score;
  document.getElementById("streak").textContent = streak;
  updateStreakBar();

  saveAttempt(currentPlayer, question, choice, correct, 300-timeLeft);
  setTimeout(newQuestion,500);
}

// ===== STREAK REWARDS =====
function handleStreakRewards(){
  let msg="";
  if(streak===3) msg="üî• Nice streak!";
  if(streak===5) msg="‚ö° Combo Master!";
  if(streak===8) msg="üåü On Fire!";
  if(msg) document.getElementById("reward").textContent = msg;
}

// ===== STREAK BAR =====
function updateStreakBar(){
  document.getElementById("streakBar").style.width = Math.min(streak*10,100)+"%";
}

// ===== TIMER & POWERUPS =====
function startTimer(){
  clearInterval(timerInterval);
  timeLeft = 300;
  document.getElementById("timer").textContent = timeLeft;
  powerupsShown=false;
  document.getElementById("powerups").innerHTML = "";

  timerInterval=setInterval(()=>{
    if(!freezeTime) timeLeft--;
    document.getElementById("timer").textContent = timeLeft;
    if(timeLeft===30 && !powerupsShown){ powerupsShown=true; showPowerUps(); }
    if(timeLeft<=0) endRound();
  },1000);
}

function showPowerUps(){
  const div = document.getElementById("powerups");
  div.innerHTML=`
    <div class="powerup" id="puFreeze" onclick="activateFreeze()">‚ùÑ Freeze Time</div>
    <div class="powerup" id="puDouble" onclick="activateDouble()">‚ú® Double Points</div>
    <div class="powerup" id="puHint" onclick="activateHint()">üí° Show Answer</div>
  `;
}

function disablePowerup(id){ const el=document.getElementById(id); if(el){ el.classList.add("disabled"); el.onclick=null; } }
function activateFreeze(){ if(freezeTime) return; freezeTime=true; powerupSound.play(); document.getElementById("reward").textContent="‚ùÑ Time Frozen for 7s!"; disablePowerup("puFreeze"); setTimeout(()=>{freezeTime=false;},7000);}
function activateDouble(){ if(doublePoints) return; doublePoints=true; powerupSound.play(); document.getElementById("reward").textContent="‚ú® Double Points for 10s!"; disablePowerup("puDouble"); setTimeout(()=>{doublePoints=false;},10000);}
function activateHint(){ powerupSound.play(); document.getElementById("reward").textContent="üí° Answer: "+currentCorrect; disablePowerup("puHint");}

// ===== START / END / HISTORY =====
function startGame(){
  const nameInput=document.getElementById("playerName");
  const name=nameInput.value.trim();
  if(!name){ alert("Please enter a name first."); return; }
  currentPlayer=name;
  score=0; streak=0; freezeTime=false; doublePoints=false;

  remainingQuestions = [...questionsFromSheet]; // initialize for this round

  document.getElementById("score").textContent = score;
  document.getElementById("streak").textContent = streak;
  document.getElementById("streakBar").style.width = "0%";
  document.getElementById("reward").textContent = "";
  document.getElementById("feedback").textContent = "";
  document.getElementById("powerups").innerHTML = "";
  document.getElementById("currentPlayerLabel").textContent = currentPlayer;

  document.getElementById("startScreen").style.display="none";
  document.getElementById("endScreen").style.display="none";
  document.getElementById("gameContainer").style.display="block";

  startTimer();
  newQuestion();
}

function playAgainSamePlayer(){ if(currentPlayer) startGame(); }
function backToStart(){ clearInterval(timerInterval); document.getElementById("gameContainer").style.display="none"; document.getElementById("endScreen").style.display="none"; document.getElementById("startScreen").style.display="block"; loadHistory(); }

// ===== SAVE ATTEMPT =====
function saveAttempt(name, question, chosenAnswer, correctAnswer, timeTaken){
  fetch(SHEET_URL,{
    method:"POST",
    body: JSON.stringify({name, question, chosenAnswer, correctAnswer, timeTaken, timestamp: new Date().toISOString()})
  }).catch(err=>console.error("Save error:",err));

  let raw=localStorage.getItem(STORAGE_KEY);
  let arr = raw ? JSON.parse(raw) : [];
  arr.push({name, score, time:new Date().toLocaleString()});
  localStorage.setItem(STORAGE_KEY,JSON.stringify(arr));
}

// ===== LOAD HISTORY =====
function loadHistory(){
  let raw=localStorage.getItem(STORAGE_KEY);
  let arr = raw ? JSON.parse(raw) : [];
  const table=document.getElementById("historyTable");
  const body=document.getElementById("historyBody");
  const emptyMsg=document.getElementById("historyEmpty");
  if(!arr.length){ table.style.display="none"; emptyMsg.style.display="block"; body.innerHTML=""; return; }
  emptyMsg.style.display="none"; table.style.display="table"; body.innerHTML="";
  arr.slice().reverse().forEach((item,index)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${index+1}</td><td>${item.name}</td><td>${item.score}</td><td>${item.time}</td>`;
    body.appendChild(tr);
  });
}

// ===== END ROUND =====
function endRound(){
  clearInterval(timerInterval);
  document.getElementById("finalPlayer").textContent=currentPlayer||"-";
  document.getElementById("finalScore").textContent=score;
  document.getElementById("gameContainer").style.display="none";
  document.getElementById("endScreen").style.display="block";
  loadHistory();
}

// ===== INIT =====
window.onload = async function(){
  await loadQuestions(); // load questions BEFORE game starts
  loadHistory();
};
</script>

</body>
</html>
